rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function role() {
      return signedIn() ? request.auth.token.role : null;
    }

    function isAdmin() { return role() == 'admin'; }
    function isAdvocate() { return role() == 'advocate'; }
    function isSupervisor() { return role() == 'supervisor'; }
    function isStudent() { return role() == 'student'; }

    function canReadContinuity() {
      return signedIn();
    }

    function canWriteContinuity() {
      return signedIn();
    }

    // --- Continuity Records (pseudonymized)
    match /continuityRecords/{careLinkId} {
      allow read: if canReadContinuity();
      allow create, update: if canWriteContinuity();
      allow delete: if isAdmin();
    }

    // --- Identity Vault (restricted)
    match /identityVault/{careLinkId} {
      allow read: if isAdvocate() || isAdmin();
      allow create, update: if isAdvocate() || isAdmin();
      allow delete: if isAdmin();
    }

    // --- Share Tokens
    // Public read-only access is allowed ONLY via direct doc get, and ONLY if token is unexpired and not revoked.
    match /shareTokens/{token} {
      allow get: if (resource.data.revokedAt == null)
                  && (
                    (resource.data.expiresAtTs != null && resource.data.expiresAtTs > request.time)
                    || (resource.data.expiresAt != null && resource.data.expiresAt > request.time.toMillis())
                  );
      allow list: if false;
      allow create: if signedIn(); // in practice: advocate/admin
      allow update: if signedIn(); // to revoke
      allow delete: if isAdmin();
    }

    // --- Audit Logs
    match /auditLogs/{id} {
      allow create: if true; // allow client to write audits; in production, prefer server-side
      allow read: if isAdmin() || isAdvocate();
      allow update, delete: if false;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
